<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>Campus Navigator AR</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            color: white;
            text-align: center;
        }

        #ui-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            padding-top: 20px;
            pointer-events: none;
            z-index: 100;
            text-shadow: 1px 1px 2px black;
        }

        #left-panel {
            position: fixed;
            top: 0;
            left: 0;
            height: 100%;
            width: 300px; /* Adjust width as needed */
            background-color: rgba(0, 0, 0, 0.5); /* Semi-transparent background */
            padding: 20px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            pointer-events: auto; /* Enable clicks on this panel */
            z-index: 101; /* Ensure it's above the AR scene */
            text-align: left;
        }

        #search-container {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            flex-wrap: wrap;
        }

        #search-input {
            padding: 8px;
            border-radius: 5px;
            border: none;
            width: 100%; /* Full width within the panel */
            background-color: rgba(255, 255, 255, 0.8);
            color: black;
            font-size: 1rem;
        }
        
        #search-button, #show-all-button {
            padding: 8px 12px;
            border-radius: 5px;
            border: none;
            background-color: rgba(0, 123, 255, 0.8);
            color: white;
            cursor: pointer;
            font-size: 1rem;
            text-shadow: none;
        }
        
        h1, h2 {
            font-size: 1.5rem;
            margin: 0 0 10px 0;
        }

        p {
            margin: 5px 0;
            font-size: 1rem;
        }

        #status-message {
            margin-top: 10px;
            font-size: 1.2rem;
            font-weight: bold;
        }

        .location-list {
            list-style: none;
            padding: 0;
            margin-top: 20px;
            width: 100%;
            overflow-y: auto; /* Enable scrolling for long lists */
        }
        
        .location-item {
            background-color: rgba(255, 255, 255, 0.2);
            padding: 10px;
            margin-bottom: 5px;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .location-item:hover {
            background-color: rgba(255, 255, 255, 0.4);
        }

    </style>

    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://raw.githack.com/AR-js-org/AR.js/master/aframe/build/aframe-ar.js"></script>

    <script>
        const campusLocations = [
            { name: "Main Building", latitude: 17.561564, longitude: 78.455154 },
            { name: "Library", latitude: 17.562090, longitude: 78.455491 },
            { name: "Cafeteria", latitude: 17.562308, longitude: 78.455895 },
            { name: "CSIT(3rd year)", latitude: 17.560994, longitude: 78.455193 }
        ];

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3;
            const φ1 = lat1 * Math.PI / 180;
            const φ2 = lat2 * Math.PI / 180;
            const Δφ = (lat2 - lat1) * Math.PI / 180;
            const Δλ = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) + Math.cos(φ1) * Math.cos(φ2) * Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
            return R * c;
        }

        AFRAME.registerComponent('ar-entity-loader', {
            schema: { searchTerm: { type: 'string', default: '' } },
            init: function () {
                const sceneEl = this.el.sceneEl;
                const statusMessage = document.getElementById('status-message');

                sceneEl.addEventListener('gps-camera-update-position', (event) => {
                    const userLat = event.detail.position.latitude;
                    const userLon = event.detail.position.longitude;
                    
                    const existingEntities = document.querySelectorAll('[gps-new-entity-place]');
                    existingEntities.forEach(el => el.remove());

                    const term = this.data.searchTerm.trim().toLowerCase();
                    let locationsToShow = term
                        ? campusLocations.filter(loc => loc.name.toLowerCase().includes(term))
                        : campusLocations;

                    if (locationsToShow.length === 0 && term !== '') {
                        statusMessage.textContent = 'No matching locations found.';
                    } else {
                        statusMessage.textContent = '';
                    }

                    locationsToShow.forEach(location => {
                        const distance = calculateDistance(userLat, userLon, location.latitude, location.longitude);

                        if (distance < 500) {
                            const entity = document.createElement('a-entity');
                            entity.setAttribute('gps-new-entity-place', { latitude: location.latitude, longitude: location.longitude });

                            const text = document.createElement('a-text');
                            text.setAttribute('value', `${location.name}\n${distance.toFixed(0)}m away`);
                            text.setAttribute('scale', '20 20 20');
                            text.setAttribute('look-at', '[gps-new-camera]');
                            text.setAttribute('align', 'center');
                            text.setAttribute('color', 'white');
                            text.setAttribute('background-color', 'rgba(0,0,0,0.5)');
                            text.setAttribute('position', '0 10 0');

                            entity.appendChild(text);
                            sceneEl.appendChild(entity);
                        }
                    });
                });
            }
        });

        function renderLocationList(filterTerm = '') {
            const listEl = document.getElementById('location-list');
            listEl.innerHTML = ''; // Clear existing list

            const filteredLocations = filterTerm
                ? campusLocations.filter(loc => loc.name.toLowerCase().includes(filterTerm.toLowerCase()))
                : campusLocations;
            
            filteredLocations.forEach(location => {
                const listItem = document.createElement('li');
                listItem.className = 'location-item';
                listItem.textContent = location.name;
                listItem.addEventListener('click', () => {
                    const searchInput = document.getElementById('search-input');
                    const sceneEl = document.querySelector('a-scene');
                    searchInput.value = location.name;
                    sceneEl.setAttribute('ar-entity-loader', { searchTerm: location.name });
                });
                listEl.appendChild(listItem);
            });
        }

        window.addEventListener('load', () => {
            const searchInput = document.getElementById('search-input');
            const searchButton = document.getElementById('search-button');
            const showAllButton = document.getElementById('show-all-button');
            const sceneEl = document.querySelector('a-scene');

            // Initial render of the list
            renderLocationList();

            searchButton.addEventListener('click', () => {
                const searchTerm = searchInput.value;
                sceneEl.setAttribute('ar-entity-loader', { searchTerm: searchTerm });
                renderLocationList(searchTerm);
            });

            showAllButton.addEventListener('click', () => {
                searchInput.value = '';
                sceneEl.setAttribute('ar-entity-loader', { searchTerm: '' });
                renderLocationList();
            });
        });
    </script>
</head>
<body>
    <a-scene 
        vr-mode-ui="enabled: false" 
        arjs="sourceType: webcam; videoTexture: true; debugUIEnabled: false;" 
        ar-entity-loader>

        <a-camera gps-new-camera look-controls></a-camera>
    </a-scene>

    <div id="left-panel">
        <h1>Campus Navigator AR</h1>
        <p>Walk around to see AR labels for nearby buildings.</p>
        <p>Ensure your device's GPS and camera are enabled.</p>
        <div id="search-container">
            <input type="text" id="search-input" placeholder="Search for a building...">
            <button id="search-button">Search</button>
            <button id="show-all-button">Show All</button>
        </div>
        <p id="status-message"></p>
        <hr style="width:100%; border: 1px solid rgba(255,255,255,0.2);">
        <h2>Campus Locations</h2>
        <ul class="location-list" id="location-list">
            </ul>
    </div>
</body>
</html>
